<div th:replace="shared/header"></div>
<script>
    var items = [];
</script>
<div class="box box-default">
    <div class="box box-body">
        <form th:action="${'/'+pageURI+'/store'}" method="post" id="dialog-form" autocomplete="off">
            <div class="row">
                <div class="col-xs-4">
                    <label>Student</label>
                    <div class="input-group">
                        <select id="form-student-id" name="student.id" class="form-control" required="required">
                            <option value="">Select Student</option>
                            <option th:each="student:${students}" th:value="${student.id}"
                                th:text="${student.firstName + ' ' + student.lastName}"></option>
                        </select>
                        <span class="input-group-btn">
                            <a href="javascript:void(0)" class="btn btn-primary add-student-btn" title="Add Student">
                                <span class="glyphicon glyphicon-plus"></span>
                        </a>
                        </span>
                    </div>
                </div>
            </div>

            <table id="mark-detail-table" class="table mark-table hide">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Mark</th>
                        <th>Full Mark</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody class="test">
                    <tr class="table-row hide">
                        <td>
                            <select name="details[0].subject.id" class="form-control subjects" required="required">
                                <option value="">Select Subject</option>
                                <option th:each="subject:${subjects}" th:value="${subject.id}" th:text="${subject.name}"></option>
                            </select>
                        </td>

                        <td>
                            <input name="details[0].mark" type="text" class="mark form-control" required="required" />
                        </td>
                        <td>
                            <td>
                                <a class="remove-item btn btn-danger btn-xs ">
                                    <span class="glyphicon glyphicon-trash"></span>
                                </a>
                            </td>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td></td>
                        <td><strong id="total">Total:</strong></td>
                        <td id="full-total">Total:</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <input type="hidden" name="id" value="0" />
            <input type="hidden" name="total" class="total" />
            <input type="hidden" name="gpa" class="gpa" value="0" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="row" style="text-align: center">
                <button type="submit" class="btn btn-success">Save</button>
                <a href="/mark" class="btn btn-danger">Back</a>
            </div>
        </form>
    </div>
</div>
<div th:replace="shared/footer"></div>

<script>
    $(function() {

        $('#dialog-form').on('change', '#form-student-id', function() {
            $('.mark-table tfoot').find('strong').html('Total: ');
            $('.mark-table').removeClass('hide');
            $id = $(this).val();
            $.ajax({
                url: '/student/json/' + $id,
                type: 'GET',
                data: {
                    _csrf: $csrf
                },
                success: function(data) {
                    $.getJSON('/student/semester/' + data.semester.id + '/' + data.program.id, function(elems) {
                        $tableBody = $('.mark-table tbody');
                        var $rows = $tableBody.find('tr');
                        $rows.remove();
                        var index = 0;
                        $.each(elems, function(i, elem) {
                            var $tr = $('<tr class="table-row"/>');
                            $('<td/>').html('<span>' + elem.name + '</span>' +
                                    '<input type="hidden" name="details[' + index +
                                    '].subject.id" class="form-control subject-val" value="' +
                                    elem.id + '">')
                                .appendTo($tr);
                            $('<td/>').html('<input type="number" name="details[' +
                                index +
                                '].mark" class="form-control mark" required="required" value="" >'
                            ).appendTo($tr);
                            $('<td/>').html('<input type="number"  class="form-control full-mark" required="required" value="100" >').appendTo($tr);
                            $tr.appendTo($tableBody);
                            index++;
                        });
                    });
                },
                error: function(err) {
                    console.log(err);
                }
            });
        });

        $('.mark-table').on('change keyup', '.mark', function() {
            $total = 0;
            $.each($('.table-row').find('.mark'), function() {
                if ($(this).val() != '') {
                    $total += parseFloat($(this).val());
                }
            });
            $('.total').val($total);
            $('.mark-table tfoot').find('strong').html('Total: ' + $total);
        });
        $('.mark-table').on('change keyup', '.full-mark', function() {
            $total = 0;
            $.each($('.table-row').find('.full-mark'), function() {
                if ($(this).val() != '') {
                    $total += parseFloat($(this).val());
                }
            });
            $('.mark-table tfoot').find('#full-total').html('Total: ' + $total);
        });

        $total = 0;
        $.each($('.table-row').find('.full-mark'), function() {
            if ($('.full-mark').val() != '') {
                $total += parseFloat($('.full-mark').val());
            }
        });
        $('.mark-table tfoot').find('#full-total').html('Total: ' + $total);

    });
</script>